! Configuration File for keepalived
global_defs {
    notification_email {
        sysadmin@test.com
    }
    notification_email_from keepalived@test.com
    smtp_server 192.168.1.1
    smtp_connect_timeout 30
    
    #router_id {{ ansible_hostname }}
    router_id {{ inventory_hostname }}
    
    vrrp_skip_check_adv_addr
    vrrp_garp_interval 0
    vrrp_gna_interval 0
}
vrrp_script chk_apiserver {
    script "/etc/keepalived/check_apiserver.sh"
    interval 5
    weight -5
    fall 2  
    rise 1
}
{% if inventory_hostname in groups['lb-app'][0] %}
vrrp_instance VI_1 {
    state MASTER
    interface {{ keepalived_vip_interface | default('eth0') }}
    virtual_router_id 51
    priority 200
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        {{ elb_vip }} dev {{ keepalived_vip_interface | default('eth0') }}
    }
    track_script {
       chk_apiserver
    }
}
{% endif %}

{% if inventory_hostname in groups['lb-app'][1] %}
vrrp_instance VI_1 {
    state BUCKUP
    interface {{ keepalived_vip_interface | default('eth0') }}
    virtual_router_id 51
    priority 150
    advert_int 2
    authentication {
        auth_type PASS
        auth_pass K8SHA_KA_AUTH
    }
    virtual_ipaddress {
        {{ elb_vip }} dev {{ keepalived_vip_interface | default('eth0') }}
    }
    track_script {
       chk_apiserver
    }
}
{% endif %}

